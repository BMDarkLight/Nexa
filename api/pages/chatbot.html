<html>
    <head>
        <title>Organizational AI API</title>
        <meta charset="UTF-8" />
    </head>
    <body style="font-family: Arial, sans-serif; background-color: #f4f4f4; color: #333; padding: 20px;">
        <h1>Chatbot Interface</h1>

        <div id="auth-section">
            <h2>Login</h2>
            <div id="login-container" style="display: flex; justify-content: space-between; border: 1px solid #ccc; padding: 20px; margin: 20px; border-radius: 10px;background-color: #f9f9f9; text-align: center;">
                <form id="login-form">
                    <label>Username: <input type="text" id="login-username" required></label><br>
                    <label>Password: <input type="password" id="login-password" required></label><br>
                    <button type="submit">Login</button>
                </form>
            </div>
            <pre id="auth-output"></pre>
        </div>

        <div id="agent-section" style="display: none; margin-bottom: 20px;">
            <h2>Select Agent (optional)</h2>
            <select id="agent-select" style="padding: 5px; min-width: 200px;">
                <option value="">Generalist (Default Agent)</option>
            </select>
            <button id="refresh-agents">Refresh</button>
            <button id="show-create-agent">Create New Agent</button>
            <div id="create-agent-form" style="display: none; margin-top: 10px;">
                <h3>Create Agent</h3>
                <form id="agent-create-form">
                    <label>Name: <input type="text" id="agent-name" required></label><br>
                    <label>Description: <input type="text" id="agent-description"></label><br>
                    <label>Tools:<br>
                        <select id="agent-tools" multiple style="min-width:200px; min-height:60px;"></select>
                    </label><br>
                    <button type="submit">Create</button>
                    <button type="button" id="cancel-create-agent">Cancel</button>
                </form>
                <pre id="create-agent-output"></pre>
            </div>
        </div>

        <div id="chat-container" style="display: none; border: 1px solid #ccc;">
            <div id="chat-history" style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;"></div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <input type="text" id="user-input" placeholder="Type your message here..." style="flex: 1; padding: 10px; box-sizing: border-box;">
                <button id="send-button">Send</button>
            </div>
        </div>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown.min.css">
        <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
        <script>
            function renderMarkdown(text) {
                return marked.parse(text || "");
            }
        </script>

        <script>
        const sessionId = Math.random().toString(36).substring(2, 18);
        let selectedAgentId = "";
        let agentsList = [];
        let toolsList = [];

        function show(elementId) {
            document.getElementById(elementId).style.display = "";
        }
        function hide(elementId) {
            document.getElementById(elementId).style.display = "none";
        }

        // Example: You may want to fetch available tools from backend
        async function fetchTools() {
            // Replace this with your backend endpoint if available
            // For demo, we'll use a static list
            toolsList = [
                { id: "search", name: "Web Search" },
                { id: "calendar", name: "Calendar" },
                { id: "crm", name: "CRM" },
                { id: "email", name: "Email" }
            ];
            const select = document.getElementById("agent-tools");
            select.innerHTML = "";
            toolsList.forEach(tool => {
                const opt = document.createElement("option");
                opt.value = tool.id;
                opt.textContent = tool.name;
                select.appendChild(opt);
            });
        }

        async function fetchAgents() {
            const token = localStorage.getItem("access_token");
            const select = document.getElementById("agent-select");
            select.innerHTML = "<option value=''>Generalist (Default Agent)</option>";
            try {
                const resp = await fetch("/agents", {
                    headers: { "Authorization": "Bearer " + token }
                });
                if (!resp.ok) throw new Error("Failed to fetch agents");
                agentsList = await resp.json();
                if (agentsList.length === 0) {
                    // Only default agent
                    selectedAgentId = "";
                } else {
                    agentsList.forEach(agent => {
                        const opt = document.createElement("option");
                        opt.value = agent.id || agent._id || "";
                        opt.textContent = agent.name || "Unnamed Agent";
                        select.appendChild(opt);
                    });
                    // Default to generalist if nothing selected
                    selectedAgentId = select.value;
                }
            } catch (e) {
                select.innerHTML = "<option value=''>Error loading agents</option>";
                selectedAgentId = "";
            }
        }

        document.getElementById("login-form").addEventListener("submit", async function(e) {
            e.preventDefault();
            const username = document.getElementById("login-username").value;
            const password = document.getElementById("login-password").value;
            const formData = new URLSearchParams();
            formData.append("username", username);
            formData.append("password", password);

            const response = await fetch("/signin", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: formData
            });

            const result = await response.json();
            if (response.ok) {
                localStorage.setItem("access_token", result.access_token);
                hide("auth-section");
                show("agent-section");
                await fetchTools();
                await fetchAgents();
                show("chat-container");
            }
            document.getElementById("auth-output").textContent = JSON.stringify(result, null, 2);
        });

        document.getElementById("refresh-agents").addEventListener("click", fetchAgents);

        document.getElementById("agent-select").addEventListener("change", function() {
            selectedAgentId = this.value;
        });

        document.getElementById("show-create-agent").addEventListener("click", function() {
            show("create-agent-form");
        });

        document.getElementById("cancel-create-agent").addEventListener("click", function() {
            hide("create-agent-form");
            document.getElementById("agent-create-form").reset();
            document.getElementById("create-agent-output").textContent = "";
        });

        document.getElementById("agent-create-form").addEventListener("submit", async function(e) {
            e.preventDefault();
            const name = document.getElementById("agent-name").value;
            const description = document.getElementById("agent-description").value;
            const toolsSelect = document.getElementById("agent-tools");
            const selectedTools = Array.from(toolsSelect.selectedOptions).map(opt => opt.value);
            const token = localStorage.getItem("access_token");
            const output = document.getElementById("create-agent-output");
            output.textContent = "";
            try {
                const resp = await fetch("/agents", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + token
                    },
                    body: JSON.stringify({ name, description, tools: selectedTools })
                });
                const result = await resp.json();
                if (resp.ok) {
                    output.textContent = "Agent created!";
                    hide("create-agent-form");
                    await fetchAgents();
                    document.getElementById("agent-create-form").reset();
                } else {
                    output.textContent = "Error: " + (result.detail || JSON.stringify(result));
                }
            } catch (e) {
                output.textContent = "Error: " + e;
            }
        });

        document.getElementById("send-button").addEventListener("click", async function() {
            document.getElementById("send-button").disabled = true;
            document.getElementById("send-button").textContent = "Sending...";
            document.getElementById("user-input").disabled = true;
            const token = localStorage.getItem("access_token");
            const userInput = document.getElementById("user-input").value;

            if (!token || !userInput) {
                alert("Missing token or input.");
                document.getElementById("send-button").disabled = false;
                document.getElementById("send-button").textContent = "Send";
                document.getElementById("user-input").disabled = false;
                return;
            }

            // agentId is optional now
            const agentId = selectedAgentId || undefined;

            // Streaming response
            const chatHistory = document.getElementById("chat-history");
            chatHistory.innerHTML += `<div><b>You:</b> ${userInput}</div>`;
            // Generate a unique id for this bot response
            const botResponseId = `bot-response-${Date.now()}-${Math.floor(Math.random()*10000)}`;
            const botTypingId = `bot-typing-${Date.now()}-${Math.floor(Math.random()*10000)}`;
            chatHistory.innerHTML += `<div id="${botTypingId}"><b>Bot:</b> <span id="${botResponseId}"></span></div>`;
            document.getElementById("user-input").value = "";
            chatHistory.scrollTop = chatHistory.scrollHeight;

            try {
                const body = { query: userInput, session_id: sessionId };
                if (agentId) body.agent_id = agentId;
                const resp = await fetch("/ask", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + token
                    },
                    body: JSON.stringify(body)
                });

                if (!resp.ok) {
                    const result = await resp.json();
                    alert("Error: " + (result.detail || JSON.stringify(result)));
                    document.getElementById("send-button").disabled = false;
                    document.getElementById("send-button").textContent = "Send";
                    document.getElementById("user-input").disabled = false;
                    const botTypingElem = document.getElementById(botTypingId);
                    if (botTypingElem) botTypingElem.remove();
                    return;
                }

                const reader = resp.body.getReader();
                const decoder = new TextDecoder();
                let botResponse = "";
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    botResponse += decoder.decode(value, { stream: true });
                    const botResponseElem = document.getElementById(botResponseId);
                    if (botResponseElem) botResponseElem.textContent = botResponse;
                    chatHistory.scrollTop = chatHistory.scrollHeight;
                }
                const botTypingElem = document.getElementById(botTypingId);
                if (botTypingElem) botTypingElem.innerHTML = `<b>Bot:</b> ${botResponse}`;
            } catch (e) {
                alert("Error: " + e);
                const botTypingElem = document.getElementById(botTypingId);
                if (botTypingElem) botTypingElem.remove();
            }
            document.getElementById("send-button").disabled = false;
            document.getElementById("send-button").textContent = "Send";
            document.getElementById("user-input").disabled = false;
        });

        document.getElementById("user-input").addEventListener("keypress", function(e) {
            if (e.key === "Enter") {
                e.preventDefault();
                document.getElementById("send-button").click();
            }
        });
        </script>
    </body>
</html>